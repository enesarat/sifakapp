import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:sifakapp/core/navigation/app_routes.dart';
import '../../../../domain/entities/medication.dart';
import '../../../blocs/medication/medication_bloc.dart';
import '../../../blocs/medication/medication_event.dart';
import '../../../blocs/medication/medication_state.dart';
import 'confirm_delete_medication_dialog.dart';

void showMedicationDetailsDialog(BuildContext context, Medication med) {
  bool isDeleting = false;            // yerel durum
  StateSetter? modalSetState;         // StatefulBuilder setState'ine erişmek için

  showDialog(
    context: context,
    barrierDismissible: !isDeleting,  // silme sırasında dışarı tıklamayla kapanmasın
    builder: (dialogCtx) {
      return BlocListener<MedicationBloc, MedicationState>(
        listenWhen: (prev, curr) =>
            curr is MedicationDeleted || curr is MedicationError,
        listener: (ctx, state) {
          if (state is MedicationDeleted && state.id == med.id) {
            // Başarılı silme -> diyaloğu kapat + snackbar göster
            Navigator.of(ctx, rootNavigator: true).pop(); // dialog'u kapat
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('İlaç silindi.')),
            );
          } else if (state is MedicationError) {
            // Hata -> butonları tekrar etkinleştir, mesajı göster
            modalSetState?.call(() => isDeleting = false);
            ScaffoldMessenger.of(ctx).showSnackBar(
              SnackBar(content: Text(state.message)),
            );
          }
        },
        child: StatefulBuilder(
          builder: (ctx, setModalState) {
            modalSetState = setModalState;
            return Dialog(
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
              insetPadding: const EdgeInsets.all(20),
              child: Stack(
                children: [
                  // ---- İçerik ----
                  Container(
                    padding: const EdgeInsets.all(20),
                    constraints: BoxConstraints(
                      maxHeight: MediaQuery.of(ctx).size.height * 0.75,
                    ),
                    child: SingleChildScrollView(
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text(
                            med.name,
                            style: Theme.of(ctx)
                                .textTheme
                                .headlineSmall
                                ?.copyWith(fontWeight: FontWeight.bold),
                            textAlign: TextAlign.center,
                          ),
                          const SizedBox(height: 12),
                          const Divider(),
                          const SizedBox(height: 12),

                          // Temel bilgiler
                          _detailRow("Tanı", med.diagnosis),
                          _detailRow("Tür", med.type),

                          // Tarihler (null-safe)
                          _detailRow("Başlangıç", _formatDate(med.startDate)),
                          if (med.endDate != null)
                            _detailRow("Bitiş", _formatDate(med.endDate)),
                          if (med.expirationDate != null)
                            _detailRow("SKT", _formatDate(med.expirationDate)),

                          // Miktarlar
                          _detailRow("Toplam Hap", med.totalPills.toString()),
                          _detailRow("Kalan Hap", med.remainingPills.toString()),
                          _detailRow("Günlük Doz", med.dailyDosage.toString()),

                          // Planlama modları
                          _detailRow("Saat Planı", _scheduleModeLabel(med.timeScheduleMode)),
                          _detailRow(
                            "Gün Planı",
                            "${_scheduleModeLabel(med.dayScheduleMode)}${med.isEveryDay ? ' • Her gün' : ''}",
                          ),
                          if (!med.isEveryDay && med.usageDays != null && med.usageDays!.isNotEmpty)
                            _detailRow("Kullanılacak Günler", _formatUsageDays(med.usageDays)),

                          // Hatırlatıcı saatler
                          if (med.reminderTimes != null && med.reminderTimes!.isNotEmpty)
                            _detailRow(
                              "Hatırlatıcı Saatler",
                              med.reminderTimes!.map((e) => e.format(ctx)).join(', '),
                            ),

                          // Yemek ilişkisi
                          if (med.isAfterMeal != null)
                            _detailRow(
                              "Yemek Zamanı",
                              _formatMeal(med),
                            ),

                          const SizedBox(height: 24),

                          // Aksiyonlar
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                            children: [
                              OutlinedButton.icon(
                                onPressed: isDeleting
                                    ? null
                                    : () {
                                        Navigator.of(ctx).pop(); // Dialog'u kapat
                                        Future.microtask(() => context.push(
                                              MedicationEditRoute(id: med.id).location,
                                              extra: med,
                                            ));
                                      },
                                icon: const Icon(Icons.edit, color: Colors.blue),
                                label: const Text("Düzenle",
                                    style: TextStyle(color: Colors.blue)),
                              ),
                              OutlinedButton.icon(
                                onPressed: isDeleting
                                    ? null
                                    : () async {
                                        final confirmed =
                                            await showConfirmDeleteMedicationDialog(ctx, med: med);
                                        if (confirmed == true) {
                                          setModalState(() => isDeleting = true);

                                          ScaffoldMessenger.of(context).showSnackBar(
                                            const SnackBar(
                                              content: Text('İlaç siliniyor...'),
                                              duration: Duration(seconds: 2),
                                            ),
                                          );
                                          ctx.read<MedicationBloc>().add(RemoveMedication(med.id));
                                          // Success gelince BlocListener kapatacak.
                                        }
                                      },
                                icon: const Icon(Icons.delete, color: Colors.red),
                                label: const Text("Sil",
                                    style: TextStyle(color: Colors.red)),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),

                  // ---- Silme sırasında overlay/progress ----
                  if (isDeleting)
                    Positioned.fill(
                      child: Container(
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.05),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        alignment: Alignment.center,
                        child: const CircularProgressIndicator(),
                      ),
                    ),
                ],
              ),
            );
          },
        ),
      );
    },
  );
}

Widget _detailRow(String label, String value) {
  return Padding(
    padding: const EdgeInsets.symmetric(vertical: 6.0),
    child: Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(width: 4),
        Expanded(
          flex: 4,
          child: Text(
            "$label:",
            style: const TextStyle(fontWeight: FontWeight.w600),
          ),
        ),
        Expanded(
          flex: 6,
          child: Text(
            value,
            style: TextStyle(color: Colors.grey[700]),
          ),
        ),
      ],
    ),
  );
}

// -------------------------
// Helpers (null-safe)
// -------------------------

String _formatDate(DateTime? dt) {
  if (dt == null) return '—';
  final d = dt.toLocal();
  final y = d.year.toString().padLeft(4, '0');
  final m = d.month.toString().padLeft(2, '0');
  final day = d.day.toString().padLeft(2, '0');
  return '$y-$m-$day';
}

String _scheduleModeLabel(ScheduleMode mode) {
  switch (mode) {
    case ScheduleMode.automatic:
      return 'Otomatik';
    case ScheduleMode.manual:
      return 'Manuel';
  }
}

String _formatUsageDays(List<int>? days) {
  if (days == null || days.isEmpty) return '—';
  const names = {
    1: 'Pzt', 2: 'Sal', 3: 'Çar', 4: 'Per', 5: 'Cum', 6: 'Cts', 7: 'Paz',
  };
  return days.map((d) => names[d] ?? d.toString()).join(', ');
}

String _formatMeal(Medication m) {
  final suffix = (m.hoursBeforeOrAfterMeal != null && m.hoursBeforeOrAfterMeal != 0)
      ? ' ${m.hoursBeforeOrAfterMeal} sa'
      : '';
  return m.isAfterMeal! ? 'Yemekten sonra$suffix' : 'Yemekten önce$suffix';
}

